<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Analytics Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/regression/2.0.1/regression.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.12.1/plotly.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="relative h-screen bg-cover bg-center" style="background-image: url('firstimage.png');">
    <!-- Login Page -->
    <div class="flex justify-center items-center h-screen" id="loginPage">
        <div class="bg-white rounded-lg shadow-md w-full max-w-md p-10 text-center">
            <h1 class="text-blue-500 text-2xl font-bold mb-8">Excel Analytics Platform</h1>
            <form id="loginForm">
                <div class="mb-5 text-left">
                    <label for="username" class="block mb-2 font-medium">Username</label>
                    <input type="text" id="username" required class="w-full p-3 border border-gray-200 rounded-md focus:outline-none focus:border-blue-500 transition-colors">
                </div>
                <div class="mb-5 text-left">
                    <label for="password" class="block mb-2 font-medium">Password</label>
                    <input type="password" id="password" required class="w-full p-3 border border-gray-200 rounded-md focus:outline-none focus:border-blue-500 transition-colors">
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white px-5 py-3 rounded-md hover:bg-blue-600 transition-colors cursor-pointer">Login</button>
            </form>
            <div id="loginError" class="hidden mt-5 p-4 rounded-md bg-red-50 text-red-500 border border-red-500 font-medium text-center">
                Invalid username or password
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="hidden" id="dashboardPage">
        <header class="bg-blue-500 text-white py-4">
            <nav class="flex justify-between items-center max-w-7xl mx-auto px-5">
                <div class="text-2xl font-bold">Excel Analytics</div>
                <div class="flex items-center">
                    <span id="userDisplay" class="mr-4"></span>
                    <button class="border border-white bg-transparent text-white px-3 py-1.5 rounded hover:bg-white/10 transition-colors cursor-pointer" id="logoutBtn">Logout</button>
                </div>
            </nav>
        </header>

        <div class="max-w-7xl mx-auto p-5">
            <div class="bg-white rounded-lg shadow-md p-8 mt-8 text-center">
                <h2 class="text-xl font-semibold mb-5">Upload Your Excel File</h2>
                <div class="relative inline-block mb-5">
                    <input type="file" id="excelFile" class="absolute left-0 top-0 opacity-0 w-full h-full cursor-pointer" accept=".xlsx, .xls, .csv">
                    <label for="excelFile" class="inline-block bg-blue-500 text-white px-5 py-3 rounded-md hover:bg-blue-600 transition-colors cursor-pointer">Choose File</label>
                </div>
                <div class="text-gray-500 italic" id="fileName">No file selected</div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-5 mt-5 hidden" id="controlsSection">
                <div class="flex mb-5 border-b border-gray-200 overflow-x-auto">
                    <button class="py-2.5 px-5 border-b-2 border-blue-500 text-blue-500 hover:text-blue-500 cursor-pointer transition-colors active-tab" data-tab="dataPreview">Data Preview</button>
                    <button class="py-2.5 px-5 border-b-2 border-transparent hover:text-blue-500 cursor-pointer transition-colors" data-tab="barChart">Bar Chart</button>
                    <button class="py-2.5 px-5 border-b-2 border-transparent hover:text-blue-500 cursor-pointer transition-colors" data-tab="pieChart">Pie Chart</button>
                    <button class="py-2.5 px-5 border-b-2 border-transparent hover:text-blue-500 cursor-pointer transition-colors" data-tab="histogram">Histogram</button>
                    <button class="py-2.5 px-5 border-b-2 border-transparent hover:text-blue-500 cursor-pointer transition-colors" data-tab="bubbleChart">Bubble Chart</button>
                    <button class="py-2.5 px-5 border-b-2 border-transparent hover:text-blue-500 cursor-pointer transition-colors" data-tab="regression">Linear Regression</button>
                    <button class="py-2.5 px-5 border-b-2 border-transparent hover:text-blue-500 cursor-pointer transition-colors" data-tab="3dBarChart">3D Bar Chart</button>
                    <button class="py-2.5 px-5 border-b-2 border-transparent hover:text-blue-500 cursor-pointer transition-colors" data-tab="3dPieChart">3D Pie Chart</button>

                </div>

                <!-- Data Preview Tab -->
                <div class="block tab-content" id="dataPreviewTab">
                    <div class="w-full overflow-x-auto mt-5">
                        <table id="dataTable" class="w-full border-collapse">
                            <!-- Table content will be dynamically generated -->
                        </table>
                    </div>
                </div>

                <!-- Bar Chart Tab -->
                <div class="hidden tab-content" id="barChartTab">
                    <div class="flex flex-wrap gap-5 mb-5">
                        <div class="flex-1 min-w-[200px]">
                            <label for="barChartXAxis" class="block mb-2 font-medium">X-Axis</label>
                            <select id="barChartXAxis" class="w-full p-2.5 border border-gray-200 rounded-md text-sm"></select>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label for="barChartYAxis" class="block mb-2 font-medium">Y-Axis</label>
                            <select id="barChartYAxis" class="w-full p-2.5 border border-gray-200 rounded-md text-sm"></select>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <button class="bg-blue-500 text-white px-5 py-3 rounded-md hover:bg-blue-600 transition-colors cursor-pointer" id="generateBarChart">Generate Bar Chart</button>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <button class="bg-green-500 text-white px-5 py-3 rounded-md hover:bg-green-600 transition-colors cursor-pointer" id="downloadBarChart">Download Statistic</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-5 mt-5 min-h-[400px] flex flex-col items-center justify-center">
                        <canvas id="barChartCanvas" class="w-full h-full min-h-[400px]"></canvas>
                    </div>
                </div>

                <!-- Pie Chart Tab -->
                <div class="hidden tab-content" id="pieChartTab">
                    <div class="flex flex-wrap gap-5 mb-5">
                        <div class="flex-1 min-w-[200px]">
                            <label for="pieChartLabels" class="block mb-2 font-medium">Label Column</label>
                            <select id="pieChartLabels" class="w-full p-2.5 border border-gray-200 rounded-md text-sm"></select>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label for="pieChartValues" class="block mb-2 font-medium">Value Column</label>
                            <select id="pieChartValues" class="w-full p-2.5 border border-gray-200 rounded-md text-sm"></select>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <button class="bg-blue-500 text-white px-5 py-3 rounded-md hover:bg-blue-600 transition-colors cursor-pointer" id="generatePieChart">Generate Pie Chart</button>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <button class="bg-green-500 text-white px-5 py-3 rounded-md hover:bg-green-600 transition-colors cursor-pointer" id="downloadPieChart">Download Statistic</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-5 mt-5 min-h-[400px] flex flex-col items-center justify-center">
                        <canvas id="pieChartCanvas" class="w-full h-full min-h-[400px]"></canvas>
                    </div>
                </div>

                <!-- Histogram Tab -->
                <div class="hidden tab-content" id="histogramTab">
                    <div class="flex flex-wrap gap-5 mb-5">
                        <div class="flex-1 min-w-[200px]">
                            <label for="histogramColumn" class="block mb-2 font-medium">Column</label>
                            <select id="histogramColumn" class="w-full p-2.5 border border-gray-200 rounded-md text-sm"></select>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label for="histogramBins" class="block mb-2 font-medium">Number of Bins</label>
                            <input type="number" id="histogramBins" min="2" max="50" value="10" class="w-full p-2.5 border border-gray-200 rounded-md text-sm">
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <button class="bg-blue-500 text-white px-5 py-3 rounded-md hover:bg-blue-600 transition-colors cursor-pointer" id="generateHistogram">Generate Histogram</button>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <button class="bg-green-500 text-white px-5 py-3 rounded-md hover:bg-green-600 transition-colors cursor-pointer" id="downloadHistogram">Download Statistic</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-5 mt-5 min-h-[400px] flex flex-col items-center justify-center">
                        <canvas id="histogramCanvas" class="w-full h-full min-h-[400px]"></canvas>
                    </div>
                </div>

                <!-- Bubble Chart Tab -->
                <div class="hidden tab-content" id="bubbleChartTab">
                    <div class="flex flex-wrap gap-5 mb-5">
                        <div class="flex-1 min-w-[200px]">
                            <label for="bubbleChartXAxis" class="block mb-2 font-medium">X-Axis</label>
                            <select id="bubbleChartXAxis" class="w-full p-2.5 border border-gray-200 rounded-md text-sm"></select>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label for="bubbleChartYAxis" class="block mb-2 font-medium">Y-Axis</label>
                            <select id="bubbleChartYAxis" class="w-full p-2.5 border border-gray-200 rounded-md text-sm"></select>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label for="bubbleChartSize" class="block mb-2 font-medium">Bubble Size</label>
                            <select id="bubbleChartSize" class="w-full p-2.5 border border-gray-200 rounded-md text-sm"></select>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <button class="bg-blue-500 text-white px-5 py-3 rounded-md hover:bg-blue-600 transition-colors cursor-pointer" id="generateBubbleChart">Generate Bubble Chart</button>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <button class="bg-green-500 text-white px-5 py-3 rounded-md hover:bg-green-600 transition-colors cursor-pointer" id="downloadBubbleChart">Download Statistic</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-5 mt-5 min-h-[400px] flex flex-col items-center justify-center">
                        <canvas id="bubbleChartCanvas" class="w-full h-full min-h-[400px]"></canvas>
                    </div>
                </div>

                <!-- Linear Regression Tab -->
                <div class="hidden tab-content" id="regressionTab">
                    <div class="flex flex-wrap gap-5 mb-5">
                        <div class="flex-1 min-w-[200px]">
                            <label for="regressionXAxis" class="block mb-2 font-medium">X Variable (Independent)</label>
                            <select id="regressionXAxis" class="w-full p-2.5 border border-gray-200 rounded-md text-sm"></select>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label for="regressionYAxis" class="block mb-2 font-medium">Y Variable (Dependent)</label>
                            <select id="regressionYAxis" class="w-full p-2.5 border border-gray-200 rounded-md text-sm"></select>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <button class="bg-blue-500 text-white px-5 py-3 rounded-md hover:bg-blue-600 transition-colors cursor-pointer" id="generateRegression">Generate Regression</button>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <button class="bg-green-500 text-white px-5 py-3 rounded-md hover:bg-green-600 transition-colors cursor-pointer" id="downloadRegression">Download Statistic</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-5 mt-5 min-h-[400px] flex flex-col items-center justify-center">
                        <canvas id="regressionCanvas" class="w-full h-full min-h-[400px]"></canvas>
                        <div id="regressionEquation" class="mt-5 font-bold"></div>
                    </div>
                </div>
                <!-- 3D Bar Chart Tab -->
                <div class="hidden tab-content" id="3dBarChartTab">
                    <div class="flex gap-5 mb-5">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block mb-2 font-medium">X-Axis (Category)</label>
                            <select id="bar3dXAxis" class="w-full p-2.5 border border-gray-200 rounded-md text-sm"></select>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block mb-2 font-medium">Y-Axis (Value)</label>
                            <select id="bar3dYAxis" class="w-full p-2.5 border border-gray-200 rounded-md text-sm"></select>
                        </div>
                        <div class="flex-1 min-w-[200px] flex items-end">
                            <button class="bg-blue-500 text-white px-5 py-3 rounded-md hover:bg-blue-600 transition-colors cursor-pointer" onclick="generate3DBarChart()">Generate 3D Bar Chart</button>
                            <button id="download3DBarChart" class="bg-green-500 text-white px-5 py-3 rounded-md hover:bg-green-600 transition-colors cursor-pointer">Download Statistic</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-5 mt-5 min-h-[400px]">
                        <div id="bar3dChartDiv" class="w-full h-[400px]"></div>
                    </div>
                </div>
                <!-- 3D Pie Chart Tab -->
                <div class="hidden tab-content" id="3dPieChartTab">
                    <div class="flex gap-5 mb-5">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block mb-2 font-medium">Label Column</label>
                            <select id="pie3dLabels" class="w-full p-2.5 border border-gray-200 rounded-md text-sm"></select>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block mb-2 font-medium">Value Column</label>
                            <select id="pie3dValues" class="w-full p-2.5 border border-gray-200 rounded-md text-sm"></select>
                        </div>
                        <div class="flex-1 min-w-[200px] flex items-end">
                            <button class="bg-blue-500 text-white px-5 py-3 rounded-md hover:bg-blue-600 transition-colors cursor-pointer" onclick="generate3DPieChart()">Generate 3D Pie Chart</button>
                            <button id="download3DPieChart" class="bg-green-500 text-white px-5 py-3 rounded-md hover:bg-green-600 transition-colors cursor-pointer">Download Statistic</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-5 mt-5 min-h-[400px]">
                        <div id="pie3dChartDiv" class="w-full h-[400px]"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        
      // User Authentication
      const users = [
        { username: 'Subhajit Mondal', password: 'admin123' },
      { username: 'Subhajit Mondal', password: 'user123' }
    ];
    
    
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Elements
      const loginPage = document.getElementById('loginPage');
      const dashboardPage = document.getElementById('dashboardPage');
      const loginForm = document.getElementById('loginForm');
      const loginError = document.getElementById('loginError');
      const userDisplay = document.getElementById('userDisplay');
      const logoutBtn = document.getElementById('logoutBtn');
      const excelFile = document.getElementById('excelFile');
      const fileName = document.getElementById('fileName');
      const controlsSection = document.getElementById('controlsSection');
      const dataTable = document.getElementById('dataTable');

      // Data Storage
      let excelData = [];
      let headers = [];
      let currentUser = null;
      let currentChart = null;
      let regression3dPlot = null;

      // Event Listeners
      loginForm.addEventListener('submit', handleLogin);
      logoutBtn.addEventListener('click', handleLogout);
      excelFile.addEventListener('change', handleFileUpload);

      // Tab Navigation
      const tabButtons = document.querySelectorAll('[data-tab]');
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            // Remove active class from all buttons and contents
            tabButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            
            // Add active class to clicked button and corresponding content
            // Remove active styling from all tabs
            tabButtons.forEach(btn => {
                btn.classList.remove('active-tab', 'border-blue-500', 'text-blue-500');
                btn.classList.add('border-transparent');
            });

            // Add active styling to current tab
            button.classList.add('active-tab', 'border-blue-500', 'text-blue-500');
            button.classList.remove('border-transparent');
            const tabId = button.getAttribute('data-tab') + 'Tab';
            document.getElementById(tabId).classList.remove('hidden');
        });
      });

      // Chart Generation Buttons
      document.getElementById('generateBarChart').addEventListener('click', generateBarChart);
      document.getElementById('generatePieChart').addEventListener('click', generatePieChart);
      document.getElementById('generateHistogram').addEventListener('click', generateHistogram);
      document.getElementById('generateBubbleChart').addEventListener('click', generateBubbleChart);
      document.getElementById('generateRegression').addEventListener('click', generateLinearRegression);
      document.getElementById('generate3dPlot').addEventListener('click', generate3DPlot);

      // Download Buttons
      document.getElementById('downloadBarChart').addEventListener('click', () => downloadChart('barChartCanvas', 'bar_chart'));
      document.getElementById('downloadPieChart').addEventListener('click', () => downloadChart('pieChartCanvas', 'pie_chart'));
      document.getElementById('downloadHistogram').addEventListener('click', () => downloadChart('histogramCanvas', 'histogram'));
      document.getElementById('downloadBubbleChart').addEventListener('click', () => downloadChart('bubbleChartCanvas', 'bubble_chart'));
      document.getElementById('downloadRegression').addEventListener('click', () => downloadChart('regressionCanvas', 'regression_chart'));
      document.getElementById('download3DBarChart').addEventListener('click', download3DBarChart);
      document.getElementById('download3DPieChart').addEventListener('click', download3DPieChart);

      // Login Functions
      function handleLogin(e) {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        const user = users.find(u => u.username === username && u.password === password);
        
        if (user) {
            currentUser = username;
            userDisplay.textContent = `Welcome, ${username}`;
            loginPage.style.display = 'none';
            dashboardPage.style.display = 'block';
            loginError.style.display = 'none';
        } else {
            loginError.style.display = 'block';
        }
      }

      function handleLogout() {
        currentUser = null;
        loginPage.style.display = 'flex';
        dashboardPage.style.display = 'none';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
      }

      // File Handling Functions
      function handleFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        fileName.textContent = file.name;
        
        const reader = new FileReader();
        
        reader.onload = function(event) {
            const data = event.target.result;
            
            try {
                if (file.name.endsWith('.csv')) {
                    // Parse CSV
                    Papa.parse(data, {
                        header: true,
                        dynamicTyping: true,
                        complete: function(results) {
                            processData(results.data);
                        }
                    });
                } else {
                    // Parse Excel
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    processData(jsonData);
                }
            } catch (error) {
                alert('Error processing file: ' + error.message);
            }
        };
        
        if (file.name.endsWith('.csv')) {
            reader.readAsText(file);
        } else {
            reader.readAsBinaryString(file);
        }
      }

      function processData(data) {
        if (!data || data.length === 0) {
            alert('No data found in the file');
            return;
        }
        
        excelData = data;
        headers = Object.keys(data[0]);
        
        // Display controls section
        controlsSection.style.display = 'block';
        
        // Populate dropdowns
        populateDropdowns();
        
        // Display data preview
        displayDataPreview();
      }

      function populateDropdowns() {
        const selectElements = [
            'barChartXAxis', 'barChartYAxis',
            'pieChartLabels', 'pieChartValues',
            'histogramColumn',
            'bubbleChartXAxis', 'bubbleChartYAxis', 'bubbleChartSize',
            'regressionXAxis', 'regressionYAxis',
            'bar3dXAxis', 'bar3dYAxis',
            'pie3dLabels', 'pie3dValues'

        ];
        
        selectElements.forEach(id => {
            const select = document.getElementById(id);
            if (!select) return; // Skip if element doesn't exist
            
            select.innerHTML = '';
            
            headers.forEach(header => {
                const option = document.createElement('option');
                option.value = header;
                option.textContent = header;
                select.appendChild(option);
            });
            
            // Set default second column for Y-axis selects
            if (id.includes('YAxis') && headers.length > 1) {
                select.value = headers[1];
            }
            
            // Set default third column for Z-axis and size
            if ((id.includes('ZAxis') || id.includes('Size')) && headers.length > 2) {
                select.value = headers[2];
            }
        });
      }

      function displayDataPreview() {
        // Clear previous data
        dataTable.innerHTML = '';
        
        // Create table header
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            th.className = 'border border-gray-300 px-4 py-2 bg-gray-100';
            headerRow.appendChild(th);
        });
        
        thead.appendChild(headerRow);
        dataTable.appendChild(thead);
        
        // Create table body
        const tbody = document.createElement('tbody');
        
        // Display only first 10 rows
        const rowsToShow = excelData.slice(0, 10);
        
        rowsToShow.forEach(row => {
            const tr = document.createElement('tr');
            
            headers.forEach(header => {
                const td = document.createElement('td');
                td.textContent = row[header] !== null && row[header] !== undefined ? row[header] : '';
                td.className = 'border border-gray-300 px-4 py-2';
                tr.appendChild(td);
            });
            
            tbody.appendChild(tr);
        });
        
        dataTable.appendChild(tbody);
      }

      // Chart Generation Functions
      function generateBarChart() {
        const xAxis = document.getElementById('barChartXAxis').value;
        const yAxis = document.getElementById('barChartYAxis').value;
        
        const labels = excelData.map(row => row[xAxis]);
        const data = excelData.map(row => row[yAxis]);
        
        const ctx = document.getElementById('barChartCanvas').getContext('2d');
        
        // Destroy previous chart if exists
        if (currentChart) {
            currentChart.destroy();
        }
        
        currentChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: yAxis,
                    data: data,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
      }

      function generatePieChart() {
        const labelColumn = document.getElementById('pieChartLabels').value;
        const valueColumn = document.getElementById('pieChartValues').value;
        
        const labels = excelData.map(row => row[labelColumn]);
        const data = excelData.map(row => row[valueColumn]);
        
        // Generate colors
        const backgroundColors = generateColors(data.length);
        
        const ctx = document.getElementById('pieChartCanvas').getContext('2d');
        
        // Destroy previous chart if exists
        if (currentChart) {
            currentChart.destroy();
        }
        
        currentChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
      }

      function generateHistogram() {
        const column = document.getElementById('histogramColumn').value;
        const binCount = parseInt(document.getElementById('histogramBins').value);
        
        // Get numeric data
        const numericData = excelData.map(row => parseFloat(row[column])).filter(val => !isNaN(val));
        
        // Calculate min and max
        const min = Math.min(...numericData);
        const max = Math.max(...numericData);
        
        // Calculate bin width
        const binWidth = (max - min) / binCount;
        
        // Create bins
        const bins = Array(binCount).fill(0);
        const binLabels = [];
        
        // Generate bin labels
        for (let i = 0; i < binCount; i++) {
            const binStart = min + i * binWidth;
            const binEnd = binStart + binWidth;
            binLabels.push(`${binStart.toFixed(2)} - ${binEnd.toFixed(2)}`);
        }
        
        // Count values in each bin
        numericData.forEach(value => {
            // Special case for the max value
            if (value === max) {
                bins[binCount - 1]++;
                return;
            }
            
            const binIndex = Math.floor((value - min) / binWidth);
            bins[binIndex]++;
        });
        
        const ctx = document.getElementById('histogramCanvas').getContext('2d');
        
        // Destroy previous chart if exists
        if (currentChart) {
            currentChart.destroy();
        }
        
        currentChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: binLabels,
                datasets: [{
                    label: `Histogram of ${column}`,
                    data: bins,
                    backgroundColor: 'rgba(153, 102, 255, 0.5)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Frequency'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: column
                        }
                    }
                }
            }
        });
      }

      function generateBubbleChart() {
        const xAxis = document.getElementById('bubbleChartXAxis').value;
        const yAxis = document.getElementById('bubbleChartYAxis').value;
        const sizeAxis = document.getElementById('bubbleChartSize').value;
        
        // Prepare bubble data
        const bubbleData = excelData.map(row => {
            const x = parseFloat(row[xAxis]);
            const y = parseFloat(row[yAxis]);
            const r = parseFloat(row[sizeAxis]);
            
            return {
                x: isNaN(x) ? 0 : x,
                y: isNaN(y) ? 0 : y,
                r: isNaN(r) ? 5 : Math.max(5, r / 5) // Scale for better visualization
            };
        });
        
        const ctx = document.getElementById('bubbleChartCanvas').getContext('2d');
        
        // Destroy previous chart if exists
        if (currentChart) {
            currentChart.destroy();
        }
        
        currentChart = new Chart(ctx, {
            type: 'bubble',
            data: {
                datasets: [{
                    label: `${xAxis} vs ${yAxis} (size: ${sizeAxis})`,
                    data: bubbleData,
                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: xAxis
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: yAxis
                        }
                    }
                }
            }
        });
      }

      function generateLinearRegression() {
        const xAxis = document.getElementById('regressionXAxis').value;
        const yAxis = document.getElementById('regressionYAxis').value;
        
        // Get numeric data points
        const dataPoints = excelData.map(row => {
            const x = parseFloat(row[xAxis]);
            const y = parseFloat(row[yAxis]);
            
            if (!isNaN(x) && !isNaN(y)) {
                return [x, y];
            }
            return null;
        }).filter(point => point !== null);
        
        // Calculate regression
        const result = regression.linear(dataPoints);
        const slope = result.equation[0];
        const intercept = result.equation[1];
        const r2 = result.r2;
        
        // Display equation
        const equationElement = document.getElementById('regressionEquation');
        equationElement.innerHTML = `
            <p>Equation: y = ${slope.toFixed(4)}x + ${intercept.toFixed(4)}</p>
            <p>R<sup>2</sup> = ${r2.toFixed(4)}</p>
        `;
        
        // Get min and max x values for line plotting
        const xValues = dataPoints.map(point => point[0]);
        const minX = Math.min(...xValues);
        const maxX = Math.max(...xValues);
        
        // Create line points
        const lineStart = [minX, minX * slope + intercept];
        const lineEnd = [maxX, maxX * slope + intercept];
        
        const ctx = document.getElementById('regressionCanvas').getContext('2d');
        
        // Destroy previous chart if exists
        if (currentChart) {
            currentChart.destroy();
        }
        
        currentChart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        label: 'Data Points',
                        data: dataPoints.map(point => ({x: point[0], y: point[1]})),
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        pointRadius: 5
                    },
                    {
                        label: 'Regression Line',
                        data: [
                            {x: lineStart[0], y: lineStart[1]},
                            {x: lineEnd[0], y: lineEnd[1]}
                        ],
                        type: 'line',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: xAxis
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: yAxis
                        }
                    }
                }
            }
        });
      }
      function generate3DBarChart() {
        const xAxis = document.getElementById('bar3dXAxis').value;
        const yAxis = document.getElementById('bar3dYAxis').value;

        const categories = [...new Set(excelData.map(row => row[xAxis]))];
        const yValues = categories.map(cat => {
            return excelData.filter(row => row[xAxis] === cat)
                    .reduce((acc, row) => acc + parseFloat(row[yAxis] || 0), 0);
        });

        const trace = {
            x: categories,
            y: yValues,
            z: yValues.map(() => 1),
            type: 'scatter3d',
            mode: 'markers',
            marker: {
                size: 12,
                symbol: 'square',
                color: yValues,
                colorscale: 'Blues'
            }
        };

        const layout = {
            title: '3D Bar Chart',
            scene: {
                xaxis: {title: xAxis},
                yaxis: {title: yAxis},
                zaxis: {title: 'Value'}
            }
        };

        Plotly.newPlot('bar3dChartDiv', [trace], layout);
      }
      function generate3DPieChart() {
        const labelCol = document.getElementById('pie3dLabels').value;
        const valueCol = document.getElementById('pie3dValues').value;

        const labels = excelData.map(row => row[labelCol]);
        const values = excelData.map(row => parseFloat(row[valueCol]) || 0);

        const trace = {
            labels: labels,
            values: values,
            type: 'pie',
            hole: 0.3,
            marker: {
                line: {
                    color: 'white',
                width: 1
            }
            }
        };

        const layout = {
            title: '3D Pie Chart (Donut Style)',
            height: 400,
            width: 500
        };

        Plotly.newPlot('pie3dChartDiv', [trace], layout);
      }
    
      // Helper Functions
      function generateColors(count) {
        const colors = [];
        const hueStep = 360 / count;
        
        for (let i = 0; i < count; i++) {
            const hue = i * hueStep;
            colors.push(`hsla(${hue}, 70%, 60%, 0.7)`);
        }
        
        return colors;
      }
      function downloadChart(canvasId, filename) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) {
            alert("Chart not found!");
            return;
        }
    
        // Check if canvas has any content
        const ctx = canvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const hasContent = imageData.data.some(pixel => pixel !== 0);
    
        if (!hasContent) {
            alert("Please generate the chart first!");
            return;
        }

        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = `${filename}.png`;
        link.click();
      }
      function download3DBarChart() {
        const plotDiv = document.getElementById('bar3dChartDiv');
        if (!plotDiv || !plotDiv.data || plotDiv.data.length === 0) {
            alert("3D Bar Chart not found! Please generate the chart first.");
            return;
        }
  
        Plotly.downloadImage('bar3dChartDiv', {
            format: 'png',
            width: 800,
            height: 600,
            filename: '3d_bar_chart'
        });
      }
      function download3DPieChart() {
        const plotDiv = document.getElementById('pie3dChartDiv');
        if (!plotDiv || !plotDiv.data || plotDiv.data.length === 0) {
            alert("3D Pie Chart not found! Please generate the chart first.");
            return;
        }
  
        Plotly.downloadImage('pie3dChartDiv', {
            format: 'png',
            width: 800,
            height: 600,
            filename: '3d_pie_chart'
        });
      }
      // Initialize UI - make sure data preview tab is active initially
      const firstTab = document.querySelector('[data-tab="dataPreview"]');
      if (firstTab) {
        firstTab.classList.add('active');
        const firstTabContent = document.getElementById('dataPreviewTab');
        if (firstTabContent) {
            firstTabContent.classList.remove('hidden');
        }
      }
    });
    </script>
</body>
</html>
